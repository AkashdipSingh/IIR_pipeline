---
title: "Pipeline - Part 2 - Functional categorization"
author: "Akashdip Singh"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE, message = FALSE,
                      tidy = TRUE)
knitr::opts_knit$set(root.dir = "..")

```

## load libraries and stuff

```{r}
library(tidyverse)
library(DESeq2)
library(biomaRt)
library(ggpubr)
library(pheatmap)
library(lfc)
library(UpSetR)
library(readxl)
library(writexl)

todate <- format(Sys.Date(),"%y%m%d")
todate <- "230620"

plotsF <- file.path("./plots/part2",todate,"/")
outputF <- file.path("./output/part2",todate,"/")
processedF <- file.path("./processed/part2",todate,"/")
folders <- c(plotsF,outputF,processedF)
for(folder in folders){
  if(!dir.exists(folder)){
    dir.create(folder,recursive = TRUE)
  }
}

knownr <- read_lines("./data/known_receptors.txt")

```

## load receptors and annotation

Load in the predicted receptors, novel hits and annotation from the first part of the pipeline

```{r}

pred_files <- list.files("./data/pipeline/",pattern = "_predicted_receptors.txt")
new_hits <- read_lines(paste0("./data/pipeline/",pred_files[length(pred_files)]))

annot_files <- list.files("./data/pipeline/",pattern = "df_annotation_newhits.rds")
annot_gene <- readRDS(paste0("./data/pipeline/",annot_files[length(annot_files)]))

genes_single <- annot_gene %>% 
  filter(single == "single") %>% 
  pull(gene_symbol) %>% 
  unique()

genes_multi <- annot_gene %>% 
  filter(single == "multi") %>% 
  pull(gene_symbol) %>% 
  unique()

genes_known <- annot_gene %>% 
  filter(known == "known") %>% 
  pull(gene_symbol) %>% 
  unique()

genes_unknown <- annot_gene %>% 
  filter(known == "unknown") %>% 
  pull(gene_symbol) %>% 
  unique()

innate_cells <- "NK|Mono|Neutro"
adaptive_cells <- "B cells|CD4|CD8"
myeloid_cells <- "Mono|Neutro"

celltypes <- c("Neutrophils",
               "Monocytes",
               "NK cells",
               "B cells",
               "CD4 T cells",
               "CD8 T cells")

celltypes_full <- c("Neutrophils_R",
                    "Neutrophils_S",
                    "Monocytes_R",
                    "Monocytes_S",
                    "NK cells_R",
                    "NK cells_S",
                    "B cells_R",
                    "B cells_S",
                    "CD4 T cells_R",
                    "CD4 T cells_S",
                    "CD8 T cells_R",
                    "CD8 T cells_S")

annot_col <- tibble(celltype = celltypes_full) %>%
  mutate(response = case_when(str_detect(celltype, innate_cells) ~ "innate",
                              str_detect(celltype, adaptive_cells) ~ "adaptive"),
         activation = case_when(str_detect(celltype, "_R") ~ "resting",
                                str_detect(celltype, "_S") ~ "stimulated"),
         lineage = case_when(str_detect(celltype, myeloid_cells) ~ "myeloid",
                             !str_detect(celltype, myeloid_cells) ~ "lymphoid")) %>%
  column_to_rownames("celltype")

annot_colors <- list(TMtype = c(type1 = hcl.colors(3, "Temps")[1],
                                type2 = hcl.colors(3, "Temps")[2],
                                multi = hcl.colors(3, "Temps")[3]),
                     nr_ITIMs = rev(hcl.colors(20, "Batlow")),
                     known = c(known = hcl.colors(2, "Viridis")[1], 
                               unknown = hcl.colors(2, "Viridis")[2]),
                     ITSM = c(ITIM_ITSM = hcl.colors(3, "Hawaii")[1],
                              ITSM = hcl.colors(3, "Hawaii")[2],
                              noITSM = hcl.colors(3, "Hawaii")[3]),
                     response = c(innate = hcl.colors(2, "Cyan-Magenta")[1],
                                adaptive = hcl.colors(2, "Cyan-Magenta")[2]),
                     activation = c(resting = hcl.colors(2, "Green-Orange")[1],
                                     stimulated = hcl.colors(2, "Green-Orange")[2]),
                     lineage = c(myeloid = hcl.colors(2, "Harmonic")[1],
                                 lymphoid = hcl.colors(2, "Harmonic")[2]))

```

## functions

```{r}

nice_theme <- theme(axis.text = element_text(size = 18),
                    axis.title.x = element_blank(),
                    axis.title.y = element_text(size = 15),
                    legend.text = element_text(size = 14),
                    legend.title = element_text(size = 16),
                    panel.grid.major.x = element_blank(),
                    panel.grid.minor = element_blank())

pheatmap_c <- function(x, width = 10, height = 35, 
                       gaps_col = seq(from = 0, to = ncol(x), by = 2),
                       cluster_cols = FALSE,
                       annotation_colors = annot_colors,
                       annotation_row = annot_gene,
                       annotation_col = annot_col, ...){
  x %>%  
    pheatmap(annotation_row = annotation_row,
             annotation_colors = annotation_colors,
             annotation_col = annotation_col,
             cluster_cols = cluster_cols,
             gaps_col = gaps_col,
             width = width, height = height,
             ...)
}

```

## load immune cell data

First we load in the RNAseq data from (10.1038/s41588-019-0505-9). We match the IDs to gene symbols and normalize the count matrix using DESeq2 and vst. We simplify expression of all immune cell subsets into major cell types, so at the end we have expression for each cell type, in stimulated or unstimulated conditions. 

```{r}

if(!exists("df_RNA")){
  df_RNA <- read.delim("./data/RNAseq/GSE118165_RNA_gene_abundance.txt.gz") %>%
    rownames_to_column(var = "ensembl_gene_id") 
}

if(!exists("ensembl")){
  ensembl <- useMart("ensembl", dataset = "hsapiens_gene_ensembl", 
                        host = "https://oct2022.archive.ensembl.org")

  annot <- getBM(attributes = c("ensembl_gene_id","hgnc_symbol"),
                 filters = "ensembl_gene_id",
                 values = unique(df_RNA$ensembl_gene_id),
                 mart = ensembl) %>%
    dplyr::rename("gene_symbol" = "hgnc_symbol")
}

annotation_celltype <- read_xlsx("./data/RNAseq/GSE118165_annotation.xlsx")

if(!file.exists(paste0(processedF,todate,"_calderon_data.rds"))){
  counts <- df_RNA[, -1]
    
  rownames(counts) <- df_RNA[, 1]
  
  meta <- tibble(
    row = colnames(df_RNA)[-1],
    sample = case_when(str_detect(row, "U$") ~ "unstimulated",
                       str_detect(row, "S$") ~ "stimulated")) %>%
    column_to_rownames("row") %>%
    as.data.frame()
  
  dds <- DESeqDataSetFromMatrix(countData = round(counts),
                                colData = meta,
                                design = ~ sample) %>%
    DESeq()
  
  vsd <- getVarianceStabilizedData(dds)
 
  df_calderon <- vsd %>%
    as_tibble(rownames = "ensembl_gene_id") %>%
    left_join(annot) %>%
    filter(!duplicated(gene_symbol),!gene_symbol == "") %>%
    dplyr::select(-ensembl_gene_id) %>%
    pivot_longer(-c("gene_symbol") , names_to = "sample", values_to = "TPM") %>%
    mutate(sample = gsub("\\.", "-", sample),
           sample = gsub("X", "", sample)) %>%
    left_join(annotation_celltype) %>%
    mutate(celltype = paste(celltype, stimulation, sep = "_"),
           stimulation = NULL) %>% 
    filter(!str_detect(sample, "DCs-"),
           !str_detect(celltype, "gdT cells")) %>%
    group_by(gene_symbol, celltype) %>%
    summarise(meanTPM = mean(TPM)) %>%
    group_by(celltype) %>%
    mutate(median_expr = median(meanTPM)) %>%
    filter(gene_symbol %in% new_hits)
  
  rm(vsd)
  rm(dds)
  rm(df_RNA)
  rm(counts)

  df_calderon %>% 
    saveRDS(paste0(processedF,todate,"_calderon_data.rds"))
  
} else{
  df_calderon <- readRDS(paste0(processedF, todate, "_calderon_data.rds"))
}

```

## load granulocyte data

This data is from (10.1126/sciimmunol.aaf8471). We again simplify expression to just resting and stimulated samples, although there are different stimulations and timepoints. 

```{r}

if(!file.exists(paste0(processedF,todate,"_granulocyte_data.rds"))){
  files <- list.files("./data/RNAseq/GSE73313/")
  files <- files[grepl("GSM", files)]
  tables <- list()
  for (i in 1:length(files)) {
    k <- paste0("./data/RNAseq/GSE73313/", files[i])
    table <- read_delim(k)[, c("gene_id", "TPM")]
    
    filename <- gsub("_.*", "", files[i])
    
    colnames(table) <- c("gene_id", filename)
    tables[[files[i]]] <- table
  }
  
  GSE_annot <- read_delim("./data/RNAseq/GSE73313/annotation.txt",
                          col_names = c("sample_id", "sample_type"))
  
  df_GRA <- Reduce(merge, tables) %>%
    rename_at(vars(GSE_annot$sample_id), ~ GSE_annot$sample_type) %>%
    dplyr::rename("gene_symbol" = "gene_id") %>%
    as_tibble() %>%
    pivot_longer(cols = -gene_symbol,
                 names_to = "sample",
                 values_to = "TPM") %>%
    mutate(celltype = case_when(str_detect(sample, "CTL") ~ "Neutrophils_R",
                                !str_detect(sample, "CTL") ~ "Neutrophils_S")) %>%
    group_by(gene_symbol, celltype) %>%
    summarise(meanTPM = mean(log2(TPM+1))) %>% 
    group_by(celltype) %>%
    mutate(median_expr = median(meanTPM)) %>% 
    filter(gene_symbol %in% new_hits)
  
  df_GRA %>%
    saveRDS(paste0(processedF, todate, "_granulocyte_data.rds"))
  
}else{
  df_GRA <- readRDS(paste0(processedF,todate,"_granulocyte_data.rds"))
}

```

## merge datasets + funcats

Next we merge the two datasets, keeping only those genes that expressed in both. We also define functional categories based on the expression pattern before and after stimulation.


```{r}

gene_symbols_all <- intersect(df_GRA$gene_symbol, df_calderon$gene_symbol)
genes_known[!genes_known %in% gene_symbols_all]
genes_unknown[!genes_unknown %in% gene_symbols_all] %>% length()

df_all <- df_GRA %>% 
  bind_rows(df_calderon) %>% 
  mutate(celltype = factor(celltype, levels = celltypes_full)) %>% 
  na.omit() %>%
  filter(gene_symbol %in% gene_symbols_all)

if(!file.exists(paste0(processedF,todate,"_df_logFC.rds"))){
  df_logFC <- df_all %>%
    group_by(gene_symbol) %>%
    separate(celltype,
             into = c("celltype", "stimulation"),
             sep = "_") %>%
    mutate(known = case_when(gene_symbol %in% genes_known ~ "known",
                             !gene_symbol %in% genes_known ~ "unknown"),
           known = factor(known, levels = c("known", "unknown")),
           celltype = factor(celltype, levels = celltypes)) %>%
    group_by(gene_symbol, celltype) %>%
    mutate(FC = meanTPM[stimulation == "S"] / meanTPM[stimulation == "R"],
           logFC = log2(FC),
           expressed = meanTPM > median_expr,
           fun_cat = case_when(!expressed[stimulation == "R"] &
                                 !expressed[stimulation == "S"] ~ "not expressed",
                               !expressed[stimulation == "R"] &
                                 expressed[stimulation == "S"] ~ "negative feedback",
                               expressed[stimulation == "R"] &
                                 (!expressed[stimulation == "S"] | logFC < -0.5) ~ "threshold-disinhibition",
                               expressed[stimulation == "R"] & logFC > 0.5 ~ "threshold-negative feedback",
                               expressed[stimulation == "R"] & logFC <= 0.5 & logFC >= -0.5 ~ "threshold"), 
           fun_cat = factor(fun_cat, levels = c("not expressed",
                                                "negative feedback",
                                                "threshold-negative feedback",
                                                "threshold-disinhibition",
                                                "threshold")))
  
  df_logFC %>%
    saveRDS(paste0(processedF, todate, "_df_logFC.rds"))
} else{
  df_logFC <- readRDS(paste0(processedF, todate, "_df_logFC.rds"))
}

df_logFC %>% 
  ggplot(mapping = aes(x = celltype, y = median_expr, color = stimulation)) +
  geom_point()

df_matrix <- df_all %>%
  mutate(across(meanTPM, function(x) ifelse(x < median_expr,0,x))) %>% 
  pivot_wider(id_cols = gene_symbol,
              names_from = celltype,
              values_from = meanTPM) %>%
  dplyr::select(gene_symbol,any_of(celltypes_full)) %>% 
  column_to_rownames("gene_symbol") %>%
  as.matrix()

df_matrix %>% 
  saveRDS(paste0(processedF,todate,"_df_matrix.rds"))

df_matrix %>% 
  pheatmap_c(color = c("grey20",hcl.colors(n = 100,
                                           palette = "Plasma")),
             scale = "none", 
             annotation_row = NA)

```
## eLife revision figure functional categories - analysis
## authored by SVV

```{r eval = FALSE}

df_logFC_CD4_fun_cat <- df_logFC %>% 
  filter(celltype == "CD4 T cells") %>%
  filter(!duplicated(gene_symbol),!gene_symbol == "") %>%
  ungroup() %>%
  dplyr::select(gene_symbol, fun_cat)

df_logFC_CD4_fun_cat %>% 
    as_tibble() %>% 
    saveRDS(paste0(processedF,"df_logFC_CD4_fun_cat.rds"))

df_logFC_CD8_fun_cat <- df_logFC %>% 
  filter(celltype == "CD8 T cells") %>%
  filter(!duplicated(gene_symbol),!gene_symbol == "") %>%
  ungroup() %>%
  dplyr::select(gene_symbol, fun_cat)

df_logFC_CD8_fun_cat %>% 
    as_tibble() %>% 
    saveRDS(paste0(processedF,"df_logFC_CD8_fun_cat.rds"))

#check if functional categories are the same per cell type
colnames(df_logFC_CD4_fun_cat) <- c("gene_symbol", "fun_cat_CD4")
colnames(df_logFC_CD8_fun_cat) <- c("gene_symbol", "fun_cat_CD8")

functional_categories_CD4_CD8_merge <- left_join(df_logFC_CD4_fun_cat, df_logFC_CD8_fun_cat, by = "gene_symbol")

functional_categories_CD4_CD8_merge$equal_cat <- functional_categories_CD4_CD8_merge$fun_cat_CD4 == functional_categories_CD4_CD8_merge$fun_cat_CD8

functional_categories_CD4_CD8_merge %>%
  group_by(equal_cat) %>%
  summarise(n = n())
#348 have identical functional category, 50 are different

```
