---
title: "Pipeline - Part 3 - Tumour infiltrating T cells"
author: "Akashdip Singh"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE, message = FALSE,
                      tidy = TRUE)
knitr::opts_knit$set(root.dir = "..")

```

## load stuff

```{r}

library(tidyverse)
library(vroom)
library(pheatmap)
library(UpSetR)

todate <- format(Sys.Date(),"%y%m%d")
todate <- "230620"

plotsF <- file.path("./plots/part3",todate, "/")
outputF <- file.path("./output/part3",todate, "/")
processedF <- file.path("./processed/part3",todate, "/")
folders <- c(plotsF,outputF,processedF)
for(folder in folders){
  if(!dir.exists(folder)){
    dir.create(folder,recursive = TRUE)
  }
}

knownr <- read_lines("./data/known_receptors.txt")

```

## load predicted receptors and annotation

```{r}

pred_files <- list.files("./data/pipeline/",pattern = "_predicted_receptors.txt")
new_hits <- read_lines(paste0("./data/pipeline/",pred_files[length(pred_files)]))

annot_files <- list.files("./data/pipeline/",pattern = "df_annotation_newhits.rds")
annot_gene <- readRDS(paste0("./data/pipeline/",annot_files[length(annot_files)]))

genes_single <- annot_gene %>% 
  filter(single == "single") %>% 
  pull(gene_symbol) %>% 
  unique()

genes_multi <- annot_gene %>% 
  filter(single == "multi") %>% 
  pull(gene_symbol) %>% 
  unique()

genes_known <- annot_gene %>% 
  filter(known == "known") %>% 
  pull(gene_symbol) %>% 
  unique()

genes_unknown <- annot_gene %>% 
  filter(known == "unknown") %>% 
  pull(gene_symbol) %>% 
  unique()

annot_plot <- annot_gene %>% 
  distinct(gene_symbol, known) %>%
  remove_rownames() %>% 
  column_to_rownames("gene_symbol")

annot_colors <- list(known = c(known = hcl.colors(2, "Viridis")[1], 
                               unknown = hcl.colors(2, "Viridis")[2]),
                     celltype = c(CD4 = hcl.colors(2, "Cyan-Magenta")[1],
                                  CD8 = hcl.colors(2, "Cyan-Magenta")[2]))

```

## load data

Expression matrices were retrieved from Zheng et al (10.5281/zenodo.5461803, 10.1126/science.abe6474) and all known and predicted immune inhibitory receptor genes were filtered out and files were saved again

```{r eval = FALSE}

all_IIR_files <- list.files("./data/pipeline/",pattern = "_all_IIR_genes.txt")
new_receptors <- read_lines(paste0("./data/pipeline/",all_IIR_files[length(all_IIR_files)]))

ct_folder <- "D:/cancer_tcells/"
dir.create(file.path("./data/RNAseq/TILs_Zheng"))

CD8_expr <- paste0(ct_folder,"01.CD8.expr.txt")
df8 <- vroom(CD8_expr) %>%
  dplyr::rename("sample" = "...1") %>%
  as_tibble() %>%
  dplyr::select(sample, any_of(new_receptors)) %>% 
  saveRDS(paste0("./data/RNAseq/TILs_Zheng/",todate,"_df8_expr.rds"))

CD4_expr <- paste0(ct_folder,"CD4.expr.txt")
vroom(CD4_expr) %>%
  dplyr::rename("sample" = "...1") %>%
  as_tibble() %>% 
  dplyr::select(sample, any_of(new_receptors)) %>% 
  saveRDS(paste0("./data/RNAseq/TILs_Zheng/",todate,"_df4_expr.rds"))

```

## processing TIL data

Next, we load all the data for the CD4 and CD8 T cells along with their annotation, and added annotation for the larger CD4 and CD8 subsets. Later, these subsets are used for plotting, rather than the individual small meta clusters identified in the study.

```{r}

CD8_expr <- readRDS("./data/RNAseq/TILs_Zheng/221219_df8_expr.rds")
CD4_expr <- readRDS("./data/RNAseq/TILs_Zheng/221219_df4_expr.rds")

metadata8 <- readRDS(paste0("./data/RNAseq/TILs_Zheng/CD8meta.tb.rds")) %>% 
  distinct(miniCluster, dataset, meta.cluster)

CD8_subsets <- c("naive",
                 "effector memory",
                 "EMRA",
                 "KIR T cell",
                 "memory",
                 "exhausted",
                 "resident memory",
                 "other")

annot_col8 <- tibble(cluster = unique(metadata8$meta.cluster)) %>% 
  mutate(subset = case_when(grepl("Tk",cluster) ~ "KIR T cell",
                           grepl("Tem\\.",cluster) ~ "effector memory",
                           grepl("Tex\\.",cluster) ~ "exhausted",
                           grepl("Tn\\.",cluster) ~ "naive",
                           grepl("Temra\\.",cluster) ~ "EMRA",
                           grepl("Tm\\.",cluster) ~ "memory",
                           grepl("Trm\\.",cluster) ~ "resident memory",
                           TRUE ~ "other"),
        subset = factor(subset, level = CD8_subsets)) %>% 
  column_to_rownames("cluster") %>% 
  as.data.frame()

df8 <- CD8_expr %>% 
  left_join(metadata8, by = c("sample" = "miniCluster")) %>%
  left_join(as_tibble(annot_col8, rownames = "meta.cluster")) %>%
  dplyr::select(sample, meta.cluster, subset, any_of(new_hits)) %>% 
  arrange(subset) %>% 
  pivot_longer(cols = any_of(new_hits),
               names_to = "gene_symbol",
               values_to = "expr") %>% 
  mutate(celltype = "CD8")

metadata4 <- readRDS(paste0("./data/RNAseq/TILs_Zheng/CD4meta.tb.rds")) %>% 
  distinct(miniCluster, dataset, meta.cluster)

CD4_subsets <- c("naive",
                 "effector memory",
                 "EMRA",
                 "memory",
                 "Th17",
                 "regulatory", 
                 "follicular helper",
                 "other")

annot_col4 <- tibble(cluster = unique(metadata4$meta.cluster)) %>% 
  mutate(subset = case_when(grepl("Tfh",cluster) ~ "follicular helper",
                            grepl("Tem\\.",cluster) ~ "effector memory",
                            grepl("Th17\\.",cluster) ~ "Th17",
                            grepl("Tn\\.",cluster) ~ "naive",
                            grepl("Temra\\.",cluster) ~ "EMRA",
                            grepl("Tm\\.",cluster) ~ "memory",
                            grepl("Treg\\.",cluster) ~ "regulatory",
                            TRUE ~ "other"),
         subset = factor(subset, levels = CD4_subsets)) %>%
  column_to_rownames("cluster") %>% 
  as.data.frame()

df4 <- CD4_expr %>% 
  left_join(metadata4, by = c("sample" = "miniCluster")) %>%
  left_join(as_tibble(annot_col4, rownames = "meta.cluster")) %>%
  dplyr::select(sample, meta.cluster, subset, any_of(new_hits)) %>% 
  arrange(subset) %>% 
  pivot_longer(cols = any_of(new_hits),
               names_to = "gene_symbol",
               values_to = "expr") %>% 
  mutate(celltype = "CD4")

subset_order <- c("naive",
                  "effector memory",
                  "EMRA",
                  "KIR T cell",
                  "memory",
                  "exhausted",
                  "resident memory",
                  "Th17",
                  "regulatory",
                  "follicular helper",
                  "other")

df_all <- bind_rows(df8, df4) %>% 
  mutate(subset = factor(subset, levels = subset_order))

df_all %>%
  saveRDS(paste0(processedF,todate,"_df_TIL.rds"))

annot_col <- bind_rows(annot_col8, annot_col4) %>% 
  mutate(celltype = case_when(grepl("CD8",rownames(.)) ~ "CD8",
                              grepl("CD4",rownames(.)) ~ "CD4"))

annot_col %>% 
  saveRDS(paste0(processedF,todate,"_annot_col.rds"))


```
